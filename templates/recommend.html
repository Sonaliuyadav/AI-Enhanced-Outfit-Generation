{% extends "base.html" %}

{% block title %}Fashion Recommendations - AI Fashion Assistant{% endblock %}

{% block extra_css %}
<style>
    .recommend-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .recommend-title {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(45deg, #3498db, #2ecc71);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .recommend-subtitle {
        color: #5a6c7d;
        font-size: 1.1rem;
    }

    .filter-section {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 3rem;
        box-shadow: 0 10px 30px rgba(52, 152, 219, 0.1);
        border: 1px solid rgba(116, 185, 255, 0.1);
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .recommendations-section {
        margin-top: 3rem;
    }

    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .product-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(52, 152, 219, 0.1);
        transition: all 0.3s ease;
        position: relative;
        border: 1px solid rgba(116, 185, 255, 0.1);
    }

    .product-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(52, 152, 219, 0.2);
    }

    .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #74b9ff;
        font-size: 2rem;
    }

    .product-info {
        padding: 1.5rem;
    }

    .product-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }

    .product-details {
        color: #5a6c7d;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .product-details span {
        display: block;
        margin-bottom: 0.25rem;
    }

    .similarity-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(45deg, #3498db, #2ecc71);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .favorite-btn {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #74b9ff;
    }

    .favorite-btn:hover {
        background: #3498db;
        color: white;
        transform: scale(1.1);
    }

    .no-results {
        text-align: center;
        padding: 3rem;
        color: #5a6c7d;
    }

    .no-results i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #e3f2fd;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-content {
        text-align: center;
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="recommend-header">
    <h1 class="recommend-title">
        <i class="fas fa-search"></i> Fashion Recommendations
    </h1>
    <p class="recommend-subtitle">
        Find your perfect style by selecting your preferences below
    </p>
</div>

<div class="filter-section">
    <form id="recommendForm">
        <div class="filter-grid">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tags"></i> Category
                </label>
                <select id="category" class="form-control form-select" required>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-list"></i> Subcategory
                </label>
                <select id="subcategory" class="form-control form-select">
                    <option value="All">All</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-venus-mars"></i> Gender
                </label>
                <select id="gender" class="form-control form-select">
                    {% for gender in genders %}
                    <option value="{{ gender }}">{{ gender }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-clock"></i> Usage/Occasion
                </label>
                <select id="usage" class="form-control form-select">
                    {% for usage in usages %}
                    <option value="{{ usage }}">{{ usage }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-palette"></i> Color
                </label>
                <select id="color" class="form-control form-select">
                    {% for color in colors %}
                    <option value="{{ color }}">{{ color }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn">
                <i class="fas fa-search"></i> Find Recommendations
            </button>
        </div>
    </form>
</div>

<div class="recommendations-section">
    <div id="results-container" style="display: none;">
        <h2 class="section-title">
            <i class="fas fa-star"></i> Recommended for You
        </h2>
        <div id="recommendations-grid" class="recommendations-grid"></div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <p>Finding perfect recommendations for you...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Update subcategories when category changes
document.getElementById('category').addEventListener('change', async function() {
    const category = this.value;
    const subcategorySelect = document.getElementById('subcategory');
    
    try {
        const response = await axios.get('/api/get_subcategories', {
            params: { category: category }
        });
        
        subcategorySelect.innerHTML = '';
        response.data.forEach(subcat => {
            const option = document.createElement('option');
            option.value = subcat;
            option.textContent = subcat;
            subcategorySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching subcategories:', error);
    }
});

// Handle recommendation form submission
document.getElementById('recommendForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resultsContainer = document.getElementById('results-container');
    const recommendationsGrid = document.getElementById('recommendations-grid');
    
    // Show loading
    loadingOverlay.style.display = 'flex';
    
    // Collect form data
    const formData = {
        category: document.getElementById('category').value,
        subcategory: document.getElementById('subcategory').value,
        gender: document.getElementById('gender').value,
        usage: document.getElementById('usage').value,
        color: document.getElementById('color').value
    };
    
    try {
        const response = await axios.post('/api/search_recommendations', formData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.data.success) {
            const recommendations = response.data.recommendations;
            
            if (recommendations.length > 0) {
                recommendationsGrid.innerHTML = '';
                
                recommendations.forEach(product => {
                    const productCard = createProductCard(product);
                    recommendationsGrid.appendChild(productCard);
                });
                
                resultsContainer.style.display = 'block';
            } else {
                recommendationsGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>No recommendations found</h3>
                        <p>Try adjusting your filters to find more options</p>
                    </div>
                `;
                resultsContainer.style.display = 'block';
            }
        } else {
            alert('Error: ' + response.data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while fetching recommendations');
    }
    
    // Hide loading
    loadingOverlay.style.display = 'none';
});

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    console.log('Creating product card for:', product.name, 'Image URL:', product.image_url);
    
    // Create image element or placeholder
    let imageHTML;
    
    if (product.image_url && product.image_url !== null && product.image_url !== '') {
        imageHTML = `
            <img src="${product.image_url}" alt="${product.name}" class="product-image" 
                 style="display: block;"
                 onerror="console.error('Failed to load image:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
                 onload="console.log('Image loaded successfully:', this.src); this.style.display='block'; this.nextElementSibling.style.display='none';">
            <div class="product-image" style="display: none; background: #f8f9fa; align-items: center; justify-content: center; color: #74b9ff; font-size: 2rem;">
                <i class="fas fa-tshirt"></i>
            </div>`;
    } else {
        console.log('No image URL provided for:', product.name);
        imageHTML = `
            <div class="product-image" style="display: flex; background: #f8f9fa; align-items: center; justify-content: center; color: #74b9ff; font-size: 2rem;">
                <i class="fas fa-tshirt"></i>
            </div>`;
    }
    
    card.innerHTML = `
        <button class="favorite-btn" onclick="addToFavorites('${product.name}', '${JSON.stringify(product).replace(/'/g, "\\'")}')">
            <i class="fas fa-heart"></i>
        </button>
        <div class="similarity-badge">
            ${(product.similarity_score * 100).toFixed(0)}% Match
        </div>
        ${imageHTML}
        <div class="product-info">
            <div class="product-title">${product.name}</div>
            <div class="product-details">
                <span><strong>Category:</strong> ${product.category}</span>
                <span><strong>Type:</strong> ${product.article_type}</span>
                <span><strong>Color:</strong> ${product.color}</span>
                <span><strong>Usage:</strong> ${product.usage}</span>
                <span><strong>Season:</strong> ${product.season}</span>
            </div>
        </div>
    `;
    
    return card;
}

async function addToFavorites(productName, productDetails) {
    try {
        const response = await axios.post('/api/add_favorite', {
            product_name: productName,
            product_details: productDetails
        }, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.data.success) {
            // Show success feedback
            const btn = event.target.closest('.favorite-btn');
            btn.style.background = '#2ecc71';
            btn.innerHTML = '<i class="fas fa-check"></i>';
            
            setTimeout(() => {
                btn.style.background = '';
                btn.innerHTML = '<i class="fas fa-heart"></i>';
            }, 2000);
        } else {
            alert('Error: ' + response.data.message);
        }
    } catch (error) {
        console.error('Error adding to favorites:', error);
        alert('Error adding to favorites');
    }
}

// Load subcategories for initial category
document.getElementById('category').dispatchEvent(new Event('change'));
</script>
{% endblock %}